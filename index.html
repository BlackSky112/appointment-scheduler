<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dr. Khurram Ali — Appointment Manager</title>
  <style>
    :root{--accent:#2563eb;--muted:#6b7280;--card:#fff;--bg:#f3f4f6;--danger:#e11d48;font-family:Inter,system-ui,Arial;}
    body{margin:0;background:var(--bg);color:#0f172a}
    header{background:white;padding:14px 18px;box-shadow:0 1px 4px rgba(2,6,23,0.06);display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#0ea5a4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .container{max-width:1100px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    form .row{display:flex;gap:12px;margin-bottom:10px}
    label{display:block;font-size:13px;color:var(--muted)}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e6e9ee;border-radius:8px}
    .required{color:var(--danger);margin-left:6px}
    button{background:var(--accent);color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{padding:8px 6px;border-bottom:1px solid #eef2f7;font-size:13px;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .searchInput{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee}
    .history-row{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px solid #f1f5f9}
    @media(max-width:980px){.container{grid-template-columns:1fr}}
    .small{font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="logo">HK</div>
    <div>
      <h1 style="margin:0;font-size:18px">Dr. Khurram Ali — Appointment Manager</h1>
      <div class="muted small">Realtime web portal (Firebase)</div>
    </div>
  </header>

  <div class="container">
    <main>
      <section class="card">
        <h2 class="small">Add Appointment</h2>

        <form id="apptForm">
          <div class="row">
            <div style="flex:2">
              <label>Patient Name <span class="required">*</span></label>
              <input id="name" autocomplete="off" required>
            </div>
            <div style="flex:1">
              <label>Contact Number <span class="required">*</span></label>
              <input id="contact" placeholder="e.g. 03001234567" required>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Appointment Date <span class="required">*</span></label>
              <input type="date" id="date" required>
            </div>
            <div style="flex:1">
              <label>Day <span class="required">*</span></label>
              <input id="day" readonly required>
            </div>
            <div style="flex:1">
              <label>Time <span class="required">*</span></label>
              <input type="time" id="time" required>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Notes</label>
              <input id="notes" placeholder="optional">
            </div>
            <div style="display:flex;align-items:flex-end">
              <button id="submitBtn" type="submit">Add Appointment</button>
            </div>
          </div>
        </form>

        <div style="margin-top:12px" id="statusMsg" class="muted small"></div>

        <hr style="margin:14px 0">

        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0">Today's Appointments</h3>
            <div class="muted small">Automatically shows today's entries</div>
          </div>
          <div style="width:360px;display:flex;gap:8px;align-items:center">
            <input id="globalSearch" class="searchInput" placeholder="Search all patients by name or contact">
            <button id="exportCsvBtn">Export CSV</button>
          </div>
        </div>

        <table class="table" id="todayTable">
          <thead><tr><th>Time</th><th>Patient</th><th>Contact</th><th>Notes</th></tr></thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:14px">All Appointments History</h3>
        <table class="table" id="allTable">
          <thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Contact</th><th>Notes</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </main>

    <aside>
      <section class="card">
        <h3 class="small">Patient Quick Search</h3>
        <div class="muted small">Type name or contact — history appears here</div>
        <input id="searchBox" class="searchInput" placeholder="Start typing name or contact..." style="margin-top:10px">
        <div id="historyPanel" style="margin-top:12px;max-height:520px;overflow:auto"><div class="muted small">No patient selected</div></div>
      </section>
      <section class="card" style="margin-top:12px">
        <h3 class="small">Notes</h3>
        <ul style="padding-left:18px;color:var(--muted)">
          <li>All fields with <span class="required">*</span> are required.</li>
          <li>Use a local server (below) or Firebase Hosting to test reliably.</li>
        </ul>
      </section>
    </aside>
  </div>

  <!-- Use compat (namespaced) SDK to match the initializeApp + firestore() style -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // ---------- Replace with your config (you already provided this) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCm7hvZH30L_4tYipMHshhEQrRrepr_bmk",
      authDomain: "dr-khurram-appointments-47ab2.firebaseapp.com",
      projectId: "dr-khurram-appointments-47ab2",
      storageBucket: "dr-khurram-appointments-47ab2.firebasestorage.app",
      messagingSenderId: "792514534459",
      appId: "1:792514534459:web:a54547689bfd34fd88d01e",
      measurementId: "G-1TYV421H32"
    };
    // -------------------------------------------------------------------------

    // Initialize
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (err) {
      console.error('Firebase init error:', err);
      document.getElementById('statusMsg').textContent = 'Firebase initialization failed, see console.';
    }
    const db = firebase.firestore();

    // UI references
    const apptForm = document.getElementById('apptForm');
    const nameInput = document.getElementById('name');
    const contactInput = document.getElementById('contact');
    const dateInput = document.getElementById('date');
    const dayInput = document.getElementById('day');
    const timeInput = document.getElementById('time');
    const notesInput = document.getElementById('notes');
    const todayTableBody = document.querySelector('#todayTable tbody');
    const allTableBody = document.querySelector('#allTable tbody');
    const searchBox = document.getElementById('searchBox');
    const historyPanel = document.getElementById('historyPanel');
    const globalSearch = document.getElementById('globalSearch');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const statusMsg = document.getElementById('statusMsg');

    // helpers
    function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    // auto fill day when date changed
    dateInput.addEventListener('change', ()=>{
      const v = dateInput.value;
      if(!v){ dayInput.value=''; return; }
      const dt = new Date(v + 'T00:00:00');
      const w = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][dt.getDay()];
      dayInput.value = w;
    });

    // add appointment
    apptForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const patientName = nameInput.value.trim();
      const contactNumber = contactInput.value.trim();
      const appointmentDate = dateInput.value;
      const day = dayInput.value;
      const time = timeInput.value;
      const notes = notesInput.value.trim();

      if(!patientName || !contactNumber || !appointmentDate || !day || !time){
        alert('Please fill all required fields.');
        return;
      }

      statusMsg.textContent = 'Saving...';
      try {
        await db.collection('appointments').add({
          patientName,
          patientName_lc: patientName.toLowerCase(),
          contactNumber,
          appointmentDate,
          day,
          time,
          notes,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        apptForm.reset(); dayInput.value = '';
        statusMsg.textContent = 'Appointment saved.';
        setTimeout(()=>statusMsg.textContent='', 2500);
      } catch (err) {
        console.error('Save failed', err);
        alert('Save failed: ' + (err.message || err));
        statusMsg.textContent = 'Save failed (see console).';
      }
    });

    // realtime listeners
    let unsubscribeAll=null, unsubscribeToday=null;
    function startRealtime(){
      const today = todayStr();
      try {
        const qToday = db.collection('appointments').where('appointmentDate','==',today).orderBy('time');
        unsubscribeToday = qToday.onSnapshot(snap=>{
          todayTableBody.innerHTML = '';
          snap.forEach(doc=>{
            const d = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${d.time||''}</td><td>${d.patientName||''}</td><td>${d.contactNumber||''}</td><td>${d.notes||''}</td>`;
            todayTableBody.appendChild(tr);
          });
        }, err=>console.error('today listener error',err));

        const qAll = db.collection('appointments').orderBy('appointmentDate','desc').orderBy('time','desc');
        unsubscribeAll = qAll.onSnapshot(snap=>{
          allTableBody.innerHTML = '';
          snap.forEach(doc=>{
            const d = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${d.appointmentDate||''}</td><td>${d.time||''}</td><td>${d.patientName||''}</td><td>${d.contactNumber||''}</td><td>${d.notes||''}</td>`;
            allTableBody.appendChild(tr);
          });
        }, err=>console.error('all listener error',err));
      } catch(err){ console.error('Listener setup error', err); statusMsg.textContent = 'Listener setup failed (see console)'; }
    }
    startRealtime();

    // search / history panel
    const doSearch = debounce(async ()=>{
      const raw = searchBox.value.trim();
      if(!raw){ historyPanel.innerHTML = '<div class="muted small">No patient selected</div>'; return; }
      const s = raw.toLowerCase();
      historyPanel.innerHTML = '<div class="muted small">Searching...</div>';

      try {
        // name prefix query (requires patientName_lc field)
        const nameQ = db.collection('appointments')
          .where('patientName_lc','>=', s)
          .where('patientName_lc','<=', s + '\uf8ff')
          .orderBy('patientName_lc')
          .limit(50);

        // contact prefix query
        const contactQ = db.collection('appointments')
          .where('contactNumber','>=', raw)
          .where('contactNumber','<=', raw + '\uf8ff')
          .orderBy('contactNumber')
          .limit(50);

        const [nameSnap, contactSnap] = await Promise.all([nameQ.get(), contactQ.get()]);
        const map = new Map();
        nameSnap.forEach(d=>map.set(d.id, d.data()));
        contactSnap.forEach(d=>map.set(d.id, d.data()));
        const arr = Array.from(map.values()).sort((a,b)=>{
          if(a.appointmentDate === b.appointmentDate) return b.time.localeCompare(a.time);
          return b.appointmentDate.localeCompare(a.appointmentDate);
        }).slice(0,50);

        if(arr.length===0){ historyPanel.innerHTML = '<div class="muted small">No records found</div>'; return; }
        historyPanel.innerHTML = '';
        arr.forEach(row=>{
          const el = document.createElement('div');
          el.className = 'history-row';
          el.innerHTML = `<div><strong>${row.patientName}</strong> <div class="muted small">${row.contactNumber}</div><div class="muted small">${row.appointmentDate} — ${row.time} • ${row.day}</div></div><div style="min-width:90px;text-align:right">${row.notes||''}</div>`;
          historyPanel.appendChild(el);
        });
      } catch(err){ console.error('Search error', err); historyPanel.innerHTML = '<div class="muted small">Search error (see console)</div>'; }
    }, 300);

    searchBox.addEventListener('input', doSearch);

    // global search to filter All table
    globalSearch.addEventListener('input', debounce(async ()=>{
      const qv = globalSearch.value.trim().toLowerCase();
      if(!qv){ /* let realtime listener show all */ startRealtime(); return; }
      try {
        const nameQ = db.collection('appointments').where('patientName_lc','>=', qv).where('patientName_lc','<=', qv + '\uf8ff').orderBy('patientName_lc').limit(200);
        const contactQ = db.collection('appointments').where('contactNumber','>=', qv).where('contactNumber','<=', qv + '\uf8ff').orderBy('contactNumber').limit(200);
        const [a,b] = await Promise.all([nameQ.get(), contactQ.get()]);
        const map = new Map(); a.forEach(d=>map.set(d.id,d.data())); b.forEach(d=>map.set(d.id,d.data()));
        allTableBody.innerHTML = '';
        Array.from(map.values()).sort((x,y)=> (y.appointmentDate||'').localeCompare(x.appointmentDate||'')).forEach(d=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${d.appointmentDate||''}</td><td>${d.time||''}</td><td>${d.patientName||''}</td><td>${d.contactNumber||''}</td><td>${d.notes||''}</td>`;
          allTableBody.appendChild(tr);
        });
      } catch(err){ console.error('Global search error', err); }
    }, 300));

    // Export CSV
    exportCsvBtn.addEventListener('click', async ()=>{
      exportCsvBtn.disabled = true; exportCsvBtn.textContent = 'Preparing...';
      try {
        const q = await db.collection('appointments').orderBy('appointmentDate','desc').orderBy('time','desc').get();
        const rows = [];
        q.forEach(d=>rows.push(d.data()));
        const header = ['appointmentDate','time','patientName','contactNumber','day','notes'];
        const csv = [header.join(',')].concat(rows.map(r=>header.map(h=>`"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'appointments.csv'; a.click();
        URL.revokeObjectURL(url);
      } catch(err){ alert('Export failed: ' + (err.message||err)); console.error(err); }
      exportCsvBtn.disabled = false; exportCsvBtn.textContent = 'Export CSV';
    });

    // Basic error message
    window.addEventListener('error', e => console.error('Window error', e.error || e.message));
  </script>
</body>
</html>

