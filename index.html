<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Khurram Ali's Appointment Scheduler</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* Simple spinner animation */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a202c; /* tailwind's gray-900 */
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">

<div class="container bg-white rounded-xl shadow-lg p-6 md:p-10 m-4 w-full">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-2">
        Dr. Khurram Ali
    </h1>
    <h2 class="text-xl text-gray-600 text-center mb-8">
        Appointment Scheduler
    </h2>

    <div id="auth-status" class="mb-4 text-sm text-center text-gray-500 flex items-center justify-center space-x-2">
        <div class="spinner"></div>
        <span>Authenticating...</span>
    </div>

    <!-- Main Content Area -->
    <div class="flex flex-col md:flex-row gap-8">
        <!-- Left Column: Booking Form and Today's Appointments -->
        <div class="w-full md:w-1/2">
            <!-- Appointment Booking Form -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Book a New Appointment</h3>
                <form id="appointmentForm" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="patientName" class="block text-sm font-medium text-gray-700">Patient Name</label>
                        <input type="text" id="patientName" name="patientName" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="contactNumber" class="block text-sm font-medium text-gray-700">Contact Number</label>
                        <input type="tel" id="contactNumber" name="contactNumber" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="appointmentDatetime" class="block text-sm font-medium text-gray-700">Appointment Date & Time</label>
                        <input type="datetime-local" id="appointmentDatetime" name="appointmentDatetime" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div class="mt-4 text-center">
                        <button type="submit"
                                class="w-full px-6 py-2 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150 transform hover:scale-105">
                            Book Appointment
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Today's Appointments List -->
            <div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Today's Appointments</h3>
                <div id="todaysAppointmentsList" class="space-y-4">
                    <div id="loading" class="text-center text-gray-500">Loading appointments...</div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Patient History Search and Results -->
        <div class="w-full md:w-1/2">
            <!-- Patient History Results -->
            <div id="patientHistorySection" class="hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Patient History</h3>
                <div class="overflow-x-auto bg-gray-50 rounded-lg shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Date</th>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Time</th>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Name</th>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Contact</th>
                            </tr>
                        </thead>
                        <tbody id="patientHistoryTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Separator -->
    <hr class="my-10 border-gray-300">

    <!-- All Appointments List (at the end) -->
    <div>
        <h3 class="text-2xl font-semibold text-gray-700 mb-4">All Appointments</h3>
        <div id="allAppointmentsList" class="space-y-4">
            <div id="loadingAll" class="text-center text-gray-500">Loading full history...</div>
        </div>
    </div>

</div>

<!-- Custom Modal for Confirmation/Messages -->
<div id="customModal" class="modal">
    <div class="modal-content">
        <div id="modal-message" class="text-center text-gray-700 mb-4"></div>
        <div class="flex justify-center space-x-4">
            <button id="modal-confirm" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 focus:outline-none">Confirm</button>
            <button id="modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 focus:outline-none">Cancel</button>
            <button id="modal-ok" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none">OK</button>
        </div>
    </div>
</div>


<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, onSnapshot, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // You can remove this line in production to reduce console noise.
    setLogLevel('debug');

    // **YOUR FIREBASE CONFIGURATION**
    // The configuration you provided is now here.
    const firebaseConfig = {
        apiKey: "AIzaSyBb1NCZ1nGrNPUfevlew4iyGVbbuUnuXmw",
        authDomain: "appointment-scheduler-5fafc.firebaseapp.com",
        projectId: "appointment-scheduler-5fafc",
        storageBucket: "appointment-scheduler-5fafc.firebasestorage.app",
        messagingSenderId: "1080947077121",
        appId: "1:1080947077121:web:e4bec6b05ef09a42a8d000"
    };

    // The following variables are used for authentication and database paths.
    // You do not need to change these.
    const appId = 'default-app-id';
    const initialAuthToken = null; 

    let app, auth, db, userId;
    let authReady = false;
    let allAppointments = []; // Store all appointments for client-side filtering

    // UI Elements
    const authStatus = document.getElementById('auth-status');
    const appointmentForm = document.getElementById('appointmentForm');
    const todaysAppointmentsList = document.getElementById('todaysAppointmentsList');
    const allAppointmentsList = document.getElementById('allAppointmentsList');
    const loadingIndicator = document.getElementById('loading');
    const loadingAllIndicator = document.getElementById('loadingAll');
    const modal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');
    const modalOk = document.getElementById('modal-ok');
    const spinnerElement = authStatus.querySelector('.spinner');
    const authStatusText = authStatus.querySelector('span');
    const patientNameInput = document.getElementById('patientName');
    const contactNumberInput = document.getElementById('contactNumber');
    const patientHistorySection = document.getElementById('patientHistorySection');
    const patientHistoryTableBody = document.getElementById('patientHistoryTableBody');

    // Function to show the custom modal
    function showModal(message, type, onConfirm) {
        modalMessage.textContent = message;
        modalConfirm.style.display = 'none';
        modalCancel.style.display = 'none';
        modalOk.style.display = 'none';
        
        if (type === 'confirm') {
            modalConfirm.style.display = 'block';
            modalCancel.style.display = 'block';
            modalConfirm.onclick = () => { onConfirm(true); modal.style.display = 'none'; };
            modalCancel.onclick = () => { onConfirm(false); modal.style.display = 'none'; };
        } else {
            modalOk.style.display = 'block';
            modalOk.onclick = () => { modal.style.display = 'none'; };
        }
        modal.style.display = 'block';
    }

    // Initialize Firebase and Authentication
    async function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Listen for auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    spinnerElement.classList.add('hidden');
                    authStatusText.textContent = `Authenticated. Your User ID: ${userId}`;
                    authReady = true;
                    // Start listening for appointments only after auth is ready
                    setupAppointmentListener();
                } else {
                    spinnerElement.classList.remove('hidden');
                    authStatusText.textContent = `Not authenticated. Attempting anonymous sign-in...`;
                    // Try to sign in anonymously if no custom token is provided
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        authStatusText.textContent = `Authentication failed. Check console.`;
                        spinnerElement.classList.add('hidden');
                        showModal("Anonymous sign-in failed. Please check your console.", "alert");
                    }
                }
            });

            // If a custom token is available, sign in with it
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in failed:", error);
                    showModal("Failed to sign in with custom token. Attempting anonymous sign-in.", "alert");
                    // Fallback to anonymous sign-in if custom token fails
                    await signInAnonymously(auth);
                }
            }

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            authStatusText.textContent = `Initialization failed. Check console.`;
            spinnerElement.classList.add('hidden');
            showModal("Failed to initialize Firebase. Please check your console for details.", "alert");
        }
    }

    // Function to add a new appointment
    async function addAppointment(event) {
        event.preventDefault();
        if (!authReady || !userId) {
            showModal("Authentication not complete. Please wait a moment.", "alert");
            return;
        }

        const patientName = appointmentForm.patientName.value.trim();
        const contactNumber = appointmentForm.contactNumber.value.trim();
        const appointmentDatetime = appointmentForm.appointmentDatetime.value;

        if (!patientName || !contactNumber || !appointmentDatetime) {
            showModal("Please fill in all the fields.", "alert");
            return;
        }

        const appointmentData = {
            patientName: patientName,
            contactNumber: contactNumber,
            timestamp: new Date(appointmentDatetime),
            createdAt: new Date()
        };

        try {
            const appointmentsColRef = collection(db, 'artifacts', appId, 'users', userId, 'appointments');
            await addDoc(appointmentsColRef, appointmentData);
            showModal("Appointment booked successfully!", "alert");
            appointmentForm.reset();
        } catch (error) {
            console.error("Error adding document:", error);
            showModal("Failed to book appointment. Please try again.", "alert");
        }
    }

    // Function to delete an appointment
    function deleteAppointment(docId) {
        showModal("Are you sure you want to delete this appointment?", "confirm", async (confirmed) => {
            if (confirmed) {
                if (!authReady || !userId) {
                    showModal("Authentication not complete. Please wait a moment.", "alert");
                    return;
                }
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'appointments', docId);
                    await deleteDoc(docRef);
                    showModal("Appointment deleted successfully!", "alert");
                } catch (error) {
                    console.error("Error removing document: ", error);
                    showModal("Failed to delete appointment. Please try again.", "alert");
                }
            }
        });
    }

    // Function to handle the search input and filter appointments
    function handleSearch() {
        const searchTerm = (patientNameInput.value.trim() + ' ' + contactNumberInput.value.trim()).toLowerCase();

        // If search term is empty, hide the history section
        if (searchTerm.length === 0) {
            patientHistorySection.classList.add('hidden');
            return;
        }

        const searchWords = searchTerm.split(/\s+/).filter(word => word.length > 0);

        const filteredAppointments = allAppointments.filter(appt => {
            const patientNameLower = appt.patientName.toLowerCase();
            const contactNumberLower = appt.contactNumber ? appt.contactNumber.toLowerCase() : '';
            
            // Check if every search word exists in the combined name or contact
            return searchWords.every(word => {
                const combinedData = (patientNameLower + ' ' + contactNumberLower);
                return combinedData.includes(word);
            });
        });

        patientHistorySection.classList.remove('hidden');
        displayHistoryTable(filteredAppointments);
    }

    // Setup real-time listener for appointments
    function setupAppointmentListener() {
        if (!authReady || !userId) return;

        const appointmentsColRef = collection(db, 'artifacts', appId, 'users', userId, 'appointments');

        // Listen to real-time updates
        onSnapshot(appointmentsColRef, (querySnapshot) => {
            allAppointments = []; // Clear the global array
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                allAppointments.push({
                    id: doc.id,
                    ...data
                });
            });

            // Sort all appointments by timestamp
            allAppointments.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
            
            // Display today's appointments in the main list
            const today = new Date();
            const todaysAppointments = allAppointments.filter(appt => {
                const apptDate = appt.timestamp.toDate();
                return apptDate.getFullYear() === today.getFullYear() &&
                       apptDate.getMonth() === today.getMonth() &&
                       apptDate.getDate() === today.getDate();
            });
            displayAppointmentCards(todaysAppointments, todaysAppointmentsList, true);
            
            // Display all appointments in the full history list
            displayAppointmentCards(allAppointments, allAppointmentsList, true);

            // Re-run the search on every data change to update the displayed history
            handleSearch();
        }, (error) => {
            console.error("Error getting real-time appointments:", error);
            showModal("Failed to load appointments. Please check your connection.", "alert");
        });
    }

    // Function to display appointments in card format
    function displayAppointmentCards(appointments, containerElement, showDeleteButton = true) {
        if (containerElement === todaysAppointmentsList) {
            loadingIndicator.classList.add('hidden');
        } else if (containerElement === allAppointmentsList) {
            loadingAllIndicator.classList.add('hidden');
        }
        
        containerElement.innerHTML = ''; // Clear previous list
        
        if (appointments.length === 0) {
            containerElement.innerHTML = `<div class="text-center text-gray-500 py-8">No appointments found.</div>`;
            return;
        }
        
        const groupedAppointments = new Map();
        appointments.forEach(appt => {
            const date = appt.timestamp.toDate();
            const dateKey = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (!groupedAppointments.has(dateKey)) {
                groupedAppointments.set(dateKey, []);
            }
            groupedAppointments.get(dateKey).push(appt);
        });

        groupedAppointments.forEach((appts, dateKey) => {
            const dateHeader = document.createElement('h4');
            dateHeader.classList.add('text-lg', 'font-semibold', 'text-gray-700', 'mt-6', 'mb-2');
            dateHeader.textContent = dateKey;
            containerElement.appendChild(dateHeader);

            appts.forEach(appointment => {
                const appointmentCard = createAppointmentCardElement(appointment, showDeleteButton);
                containerElement.appendChild(appointmentCard);
            });
        });
    }

    // Function to display appointments in a compact table format
    function displayHistoryTable(appointments) {
        patientHistoryTableBody.innerHTML = ''; // Clear table body

        if (appointments.length === 0) {
            patientHistoryTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No matching history found.</td></tr>`;
            return;
        }

        appointments.forEach(appt => {
            const datetime = appt.timestamp.toDate();
            const formattedDate = datetime.toLocaleDateString('en-US');
            const formattedTime = datetime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-100');
            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap">${formattedDate}</td>
                <td class="px-3 py-2 whitespace-nowrap">${formattedTime}</td>
                <td class="px-3 py-2 whitespace-nowrap">${appt.patientName}</td>
                <td class="px-3 py-2 whitespace-nowrap">${appt.contactNumber}</td>
            `;
            patientHistoryTableBody.appendChild(row);
        });
    }

    // Helper function to create an appointment card element
    function createAppointmentCardElement(appointment, showDeleteButton) {
        const datetime = appointment.timestamp.toDate();
        const formattedDate = datetime.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
        const formattedDay = datetime.toLocaleDateString('en-US', { weekday: 'long' });
        const formattedTime = datetime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

        const appointmentCard = document.createElement('div');
        appointmentCard.classList.add('bg-gray-50', 'rounded-lg', 'shadow-sm', 'p-4', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-start', 'md:items-center');
        
        let deleteButtonHTML = '';
        if (showDeleteButton) {
            deleteButtonHTML = `
                <button class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition-colors duration-200">
                    Delete
                </button>
            `;
        }

        appointmentCard.innerHTML = `
            <div class="mb-2 md:mb-0">
                <p class="text-lg font-semibold text-gray-800">${appointment.patientName}</p>
                <p class="text-sm text-gray-600">${formattedDate} (${formattedDay}) at ${formattedTime}</p>
                <p class="text-sm text-gray-600">Contact: ${appointment.contactNumber}</p>
            </div>
            ${deleteButtonHTML}
        `;
        
        if (showDeleteButton) {
            const deleteButton = appointmentCard.querySelector('button');
            deleteButton.addEventListener('click', () => deleteAppointment(appointment.id));
        }

        return appointmentCard;
    }

    // Attach event listeners
    window.addEventListener('load', initFirebase);
    appointmentForm.addEventListener('submit', addAppointment);
    patientNameInput.addEventListener('input', handleSearch);
    contactNumberInput.addEventListener('input', handleSearch);

</script>
</body>
</html>
