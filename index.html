<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Khurram Ali's Appointment Scheduler (Simple Setup)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase CDN Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope for use in the main script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 550px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a202c; 
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">

<div class="container bg-white rounded-xl shadow-lg p-6 md:p-10 m-4 w-full">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-2">
        Dr. Khurram Ali
    </h1>
    <h2 class="text-xl text-gray-600 text-center mb-8">
        Appointment Scheduler (Realtime Sync)
    </h2>

    <div id="auth-status" class="mb-4 text-sm text-center text-gray-500 flex items-center justify-center space-x-2">
        <div class="spinner"></div>
        <span>Connecting to Firestore and authenticating...</span>
    </div>

    <!-- Main Content Area -->
    <div class="flex flex-col md:flex-row gap-8">
        <!-- Left Column: Booking Form and Today's Appointments -->
        <div class="w-full md:w-1/2">
            <!-- Appointment Booking Form -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Book/Edit Appointment</h3>
                <form id="appointmentForm" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="patientName" class="block text-sm font-medium text-gray-700">
                            Patient Name (Type to search history below) <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="patientName" name="patientName" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="contactNumber" class="block text-sm font-medium text-gray-700">Contact Number (11 Digits, also searchable)</label>
                        <input type="tel" id="contactNumber" name="contactNumber" pattern="[0-9]{11}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="appointmentDatetime" class="block text-sm font-medium text-gray-700">
                            Appointment Date & Time <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" id="appointmentDatetime" name="appointmentDatetime" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div class="mt-4 text-center space-x-2">
                        <button type="submit" id="formSubmitBtn"
                                class="w-full md:w-auto px-6 py-2 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150 transform hover:scale-105">
                            Book Appointment
                        </button>
                        <button type="button" id="formCancelEditBtn" style="display: none;"
                                class="w-full md:w-auto mt-2 md:mt-0 px-6 py-2 border border-transparent text-base font-medium rounded-full shadow-sm text-gray-800 bg-gray-300 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition ease-in-out duration-150">
                            Cancel Edit
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Today's Appointments List -->
            <div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Today's Appointments</h3>
                <div id="todaysAppointmentsList" class="space-y-4">
                    <div id="loading" class="text-center text-gray-500">Loading appointments...</div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Patient History Search and All Patients -->
        <div class="w-full md:w-1/2">
            <!-- Patient History Search and Results (Shows up dynamically) -->
            <div id="patientHistorySection" class="hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Patient History Search Results</h3>
                <div id="historyCount" class="text-sm text-gray-600 mb-2"></div>
                <div class="overflow-x-auto bg-gray-50 rounded-lg shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Date</th>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Time</th>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Name</th>
                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-700 tracking-wider">Contact</th>
                            </tr>
                        </thead>
                        <tbody id="patientHistoryTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="paginationControls" class="flex justify-between items-center mt-4">
                    <button id="prevPageBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 focus:outline-none">Previous</button>
                    <span id="pageInfo" class="text-gray-600"></span>
                    <button id="nextPageBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 focus:outline-none">Next</button>
                </div>
            </div>

            <!-- All Patients Section -->
            <div id="allPatientsSection" class="mt-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">All Appointments (Full List)</h3>
                <div id="allPatientsList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">Loading all patients...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Modal for Confirmation/Messages -->
<div id="customModal" class="modal">
    <div class="modal-content">
        <div id="modal-message" class="text-center text-gray-700 mb-4"></div>
        <div class="flex justify-center space-x-4">
            <button id="modal-confirm" class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-600 focus:outline-none">Confirm</button>
            <button id="modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-400 focus:outline-none">Cancel</button>
            <button id="modal-ok" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-indigo-700 focus:outline-none">OK</button>
        </div>
    </div>
</div>

<script>
    // --- 1. FIRESTORE CONFIGURATION (Automatic) ---
    // The variables __firebase_config, __initial_auth_token, and __app_id are provided automatically by the environment.
    let db, auth, userId, appId;
    const APPOINTMENTS_COLLECTION = 'appointments';
    const monthAbbreviations = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    // --- 2. GLOBAL STATE & UI ELEMENTS (for brevity) ---
    let allAppointments = []; 
    let filteredAppointments = []; 
    let currentPage = 1;
    let editingDocId = null;
    const patientsPerPage = 10;
    
    // UI elements (defined in the HTML)
    const authStatus = document.getElementById('auth-status');
    const appointmentForm = document.getElementById('appointmentForm');
    const todaysAppointmentsList = document.getElementById('todaysAppointmentsList');
    const loadingIndicator = document.getElementById('loading');
    const spinnerElement = authStatus.querySelector('.spinner');
    const authStatusText = authStatus.querySelector('span');
    const patientNameInput = document.getElementById('patientName');
    const contactNumberInput = document.getElementById('contactNumber');
    const patientHistorySection = document.getElementById('patientHistorySection');
    const patientHistoryTableBody = document.getElementById('patientHistoryTableBody');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');
    const allPatientsList = document.getElementById('allPatientsList');
    const formSubmitBtn = document.getElementById('formSubmitBtn');
    const formCancelEditBtn = document.getElementById('formCancelEditBtn');
    const historyCount = document.getElementById('historyCount');
    const modal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');
    const modalOk = document.getElementById('modal-ok');

    function showModal(message, type, onConfirm) {
        modalMessage.innerHTML = message;
        modalConfirm.style.display = 'none';
        modalCancel.style.display = 'none';
        modalOk.style.display = 'none';
        
        if (type === 'confirm') {
            modalConfirm.style.display = 'block';
            modalCancel.style.display = 'block';
            modalConfirm.onclick = () => { onConfirm(true); modal.style.display = 'none'; };
            modalCancel.onclick = () => { onConfirm(false); modal.style.display = 'none'; };
        } else {
            modalOk.style.display = 'block';
            modalOk.onclick = () => { modal.style.display = 'none'; };
        }
        modal.style.display = 'block';
    }

    // --- 3. FIRESTORE INITIALIZATION & AUTHENTICATION ---
    async function initFirestore() {
        if (typeof window.firebase === 'undefined') {
            authStatusText.textContent = "Error: Firebase libraries not loaded.";
            spinnerElement.classList.add('hidden');
            return;
        }

        try {
            // 1. Initialize App
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.getFirestore(app);
            auth = firebase.getAuth(app);
            
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // 2. Authenticate User
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            if (initialAuthToken) {
                await firebase.signInWithCustomToken(auth, initialAuthToken);
            } else {
                await firebase.signInAnonymously(auth);
            }
            
            firebase.onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    authStatusText.textContent = `Authenticated. User ID: ${userId.substring(0, 8)}...`;
                    spinnerElement.classList.add('hidden');
                    setupAppointmentListener(); // Start listening after auth is ready
                } else {
                    authStatusText.textContent = `Authentication required.`;
                    spinnerElement.classList.add('hidden');
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            authStatusText.textContent = `Initialization Failed: ${error.message}`;
            spinnerElement.classList.add('hidden');
        }
    }
    
    // Determines the storage path for the appointments collection (private data)
    function getAppointmentsCollectionRef() {
        if (!db || !userId) return null;
        // Path: /artifacts/{appId}/users/{userId}/appointments
        return firebase.collection(db, 'artifacts', appId, 'users', userId, APPOINTMENTS_COLLECTION);
    }

    // --- 4. FIRESTORE DATA LOGIC ---
    
    // Setup real-time listener for appointments
    function setupAppointmentListener() {
        const appointmentsRef = getAppointmentsCollectionRef();
        if (!appointmentsRef) return;

        // Use onSnapshot for real-time updates
        firebase.onSnapshot(appointmentsRef, (snapshot) => {
            const data = [];
            snapshot.forEach(doc => {
                data.push({ id: doc.id, ...doc.data() });
            });
            updateLocalData(data);
        }, (error) => {
            console.error("Error listening to Firestore:", error);
            showModal(`Realtime data sync failed. Error: ${error.message}`, "alert");
        });
    }

    async function handleFormSubmit(event) {
        event.preventDefault();
        const appointmentsRef = getAppointmentsCollectionRef();
        if (!appointmentsRef) return showModal("Database not ready. Please wait for authentication.", "alert");

        const patientName = appointmentForm.patientName.value.trim();
        const contactNumber = appointmentForm.contactNumber.value.trim();
        const appointmentDatetime = appointmentForm.appointmentDatetime.value;

        if (!patientName || !appointmentDatetime) {
            showModal("Please fill in all required fields (marked with *).", "alert");
            return;
        }
        if (contactNumber.length > 0 && contactNumber.length !== 11) {
            showModal("The contact number must be exactly 11 digits long.", "alert");
            return;
        }

        const appointmentData = {
            patientName: patientName,
            contactNumber: contactNumber,
            // Store the ISO string directly for Firebase
            timestamp: appointmentDatetime, 
            createdAt: new Date().toISOString()
        };

        try {
            if (editingDocId) {
                // Update existing appointment
                const docRef = firebase.doc(appointmentsRef, editingDocId);
                await firebase.updateDoc(docRef, appointmentData);
                showModal("Appointment updated successfully! Changes will sync.", "alert");
                resetForm();
            } else {
                // Add new appointment
                await firebase.addDoc(appointmentsRef, appointmentData);
                showModal("Appointment booked successfully! Changes will sync.", "alert");
                appointmentForm.reset();
            }
        } catch (error) {
            console.error("Error saving appointment:", error);
            showModal(`Failed to save appointment. Error: ${error.message}`, "alert");
        }
    }

    function deleteAppointment(docId) {
        showModal("Are you sure you want to delete this appointment? This action is permanent and will sync to all devices.", "confirm", async (confirmed) => {
            if (confirmed) {
                const appointmentsRef = getAppointmentsCollectionRef();
                if (!appointmentsRef) return;
                try {
                    const docRef = firebase.doc(appointmentsRef, docId);
                    await firebase.deleteDoc(docRef);
                    showModal("Appointment deleted successfully!", "alert");
                } catch (error) {
                    console.error("Error removing appointment: ", error);
                    showModal(`Failed to delete appointment. Error: ${error.message}`, "alert");
                }
            }
        });
    }

    // Function to update local array and refresh UI
    function updateLocalData(data) {
        // Convert the timestamp string back to Date objects for local sorting/filtering
        allAppointments = data.map(appt => ({
            ...appt,
            timestamp: new Date(appt.timestamp) 
        }));

        // Sort all appointments by timestamp (most recent first)
        allAppointments.sort((a, b) => b.timestamp - a.timestamp);
        
        // Filter and display today's appointments
        const today = new Date();
        const todaysAppointments = allAppointments.filter(appt => {
            const apptDate = appt.timestamp;
            return apptDate.getFullYear() === today.getFullYear() &&
                   apptDate.getMonth() === today.getMonth() &&
                   apptDate.getDate() === today.getDate();
        });
        
        displayAppointmentCards(todaysAppointments, todaysAppointmentsList, false); 
        
        // Re-run the search on every data change to update the displayed history
        handleSearch();

        // Display all patients (full list)
        displayAllPatients(allAppointments);
    }
    
    // --- 5. UI/SEARCH/PAGINATION LOGIC (Identical to previous versions) ---

    function handleSearch() {
        const patientSearchTerm = patientNameInput.value.trim().toLowerCase();
        const contactSearchTerm = contactNumberInput.value.trim().toLowerCase();

        if (patientSearchTerm.length === 0 && contactSearchTerm.length === 0) {
            patientHistorySection.classList.add('hidden');
            patientHistoryTableBody.innerHTML = ''; 
            historyCount.textContent = '';
            return;
        }
        
        patientHistorySection.classList.remove('hidden');

        const combinedSearchTerm = patientSearchTerm + ' ' + contactSearchTerm;
        const searchWords = combinedSearchTerm.split(/\s+/).filter(word => word.length > 0);

        filteredAppointments = allAppointments.filter(appt => {
            const patientNameLower = appt.patientName.toLowerCase();
            const contactNumberLower = appt.contactNumber ? appt.contactNumber.toLowerCase() : '';
            
            return searchWords.every(word => {
                const combinedData = (patientNameLower + ' ' + contactNumberLower);
                return combinedData.includes(word);
            });
        });
        
        currentPage = 1; 
        displayHistoryTable();
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredAppointments.length / patientsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            displayHistoryTable();
        }
    }
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            displayHistoryTable();
        }
    }

    function displayAppointmentCards(appointments, containerElement, showActions) {
        if (containerElement === todaysAppointmentsList) {
            loadingIndicator.classList.add('hidden');
        }
        containerElement.innerHTML = '';
        if (appointments.length === 0) {
            containerElement.innerHTML = `<div class="text-center text-gray-500 py-8">No appointments found.</div>`;
            return;
        }
        appointments.sort((a, b) => a.timestamp - b.timestamp);
        appointments.forEach(appointment => {
            const appointmentCard = createAppointmentCardElement(appointment, showActions);
            containerElement.appendChild(appointmentCard);
        });
    }

    function displayHistoryTable() {
        patientHistoryTableBody.innerHTML = '';
        const totalAppointments = filteredAppointments.length;
        historyCount.textContent = `Total appointments found for this patient: ${totalAppointments}`;
        const totalPages = Math.ceil(totalAppointments / patientsPerPage);
        const start = (currentPage - 1) * patientsPerPage;
        const end = start + patientsPerPage;
        const appointmentsToShow = filteredAppointments.slice(start, end);

        if (appointmentsToShow.length === 0 && (patientNameInput.value.length > 0 || contactNumberInput.value.length > 0)) {
             patientHistoryTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No matching history found.</td></tr>`;
        } else if (appointmentsToShow.length === 0) {
            patientHistoryTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">Start typing name or contact number to view history.</td></tr>`;
        }

        appointmentsToShow.forEach(appt => {
            const datetime = appt.timestamp;
            const day = datetime.getDate();
            const month = monthAbbreviations[datetime.getMonth()];
            const year = datetime.getFullYear();
            const formattedDate = `${day < 10 ? '0' : ''}${day}-${month}-${year}`;
            const formattedTime = datetime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-100');
            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap">${formattedDate}</td>
                <td class="px-3 py-2 whitespace-nowrap">${formattedTime}</td>
                <td class="px-3 py-2 whitespace-nowrap">${appt.patientName}</td>
                <td class="px-3 py-2 whitespace-nowrap">${appt.contactNumber}</td>
            `;
            patientHistoryTableBody.appendChild(row);
        });

        prevPageBtn.disabled = currentPage === 1 || totalAppointments === 0;
        nextPageBtn.disabled = currentPage === totalPages || totalAppointments === 0;
        pageInfo.textContent = totalAppointments > 0 ? `Page ${currentPage} of ${totalPages}` : '';
    }

    function displayAllPatients(appointments) {
        allPatientsList.innerHTML = '';
        if (appointments.length === 0) {
            allPatientsList.innerHTML = `<div class="text-center text-gray-500 py-8">No patients found.</div>`;
            return;
        }
        
        const groupedAppointments = new Map();
        appointments.forEach(appt => {
            const dateKey = appt.timestamp.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (!groupedAppointments.has(dateKey)) {
                groupedAppointments.set(dateKey, []);
            }
            groupedAppointments.get(dateKey).push(appt);
        });

        const sortedDateKeys = Array.from(groupedAppointments.keys()).sort((a, b) => new Date(b) - new Date(a));

        sortedDateKeys.forEach(dateKey => {
            const dateHeader = document.createElement('h4');
            dateHeader.classList.add('text-lg', 'font-semibold', 'text-gray-700', 'mt-6', 'mb-2');
            dateHeader.textContent = dateKey;
            allPatientsList.appendChild(dateHeader);

            groupedAppointments.get(dateKey).sort((a, b) => a.timestamp - b.timestamp).forEach(appointment => {
                const appointmentCard = createAppointmentCardElement(appointment, true); 
                allPatientsList.appendChild(appointmentCard);
            });
        });
    }

    function editAppointment(appointment) {
        editingDocId = appointment.id;
        patientNameInput.value = appointment.patientName;
        contactNumberInput.value = appointment.contactNumber;
        
        const datetime = appointment.timestamp;
        const formattedDatetime = `${datetime.getFullYear()}-${(datetime.getMonth() + 1).toString().padStart(2, '0')}-${datetime.getDate().toString().padStart(2, '0')}T${datetime.getHours().toString().padStart(2, '0')}:${datetime.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('appointmentDatetime').value = formattedDatetime;

        formSubmitBtn.textContent = 'Save Changes';
        formSubmitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        formSubmitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        formCancelEditBtn.style.display = 'inline-block';
        
        appointmentForm.scrollIntoView({ behavior: 'smooth' });
    }

    function resetForm() {
        appointmentForm.reset();
        editingDocId = null;
        formSubmitBtn.textContent = 'Book Appointment';
        formSubmitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        formSubmitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        formCancelEditBtn.style.display = 'none';
        handleSearch();
    }

    function createAppointmentCardElement(appointment, showActions = false) {
        const datetime = appointment.timestamp;
        const formattedDate = datetime.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
        const formattedDay = datetime.toLocaleDateString('en-US', { weekday: 'long' });
        const formattedTime = datetime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

        const appointmentCard = document.createElement('div');
        appointmentCard.classList.add('bg-white', 'rounded-lg', 'shadow', 'p-4', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-start', 'md:items-center', 'border', 'border-gray-200');
        
        let actionsHTML = '';
        if (showActions) {
             actionsHTML = `
                <div class="flex space-x-2 mt-3 md:mt-0">
                    <button class="edit-btn bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium hover:bg-green-600 transition-colors duration-200 shadow-md">
                        Edit
                    </button>
                    <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium hover:bg-red-600 transition-colors duration-200 shadow-md">
                        Delete
                    </button>
                </div>
            `;
        }

        appointmentCard.innerHTML = `
            <div class="mb-1 md:mb-0">
                <p class="text-lg font-semibold text-gray-800">${appointment.patientName}</p>
                <p class="text-sm text-gray-600">${formattedDate} (${formattedDay}) at ${formattedTime}</p>
                <p class="text-xs text-gray-500">${appointment.contactNumber ? 'Contact: ' + appointment.contactNumber : 'No contact'}</p>
            </div>
            ${actionsHTML}
        `;
        
        if (showActions) {
            appointmentCard.querySelector('.edit-btn').addEventListener('click', () => editAppointment(appointment));
            appointmentCard.querySelector('.delete-btn').addEventListener('click', () => deleteAppointment(appointment.id));
        }

        return appointmentCard;
    }

    // --- 6. EVENT LISTENERS ---
    window.addEventListener('load', initFirestore);
    appointmentForm.addEventListener('submit', handleFormSubmit);
    patientNameInput.addEventListener('input', handleSearch);
    contactNumberInput.addEventListener('input', handleSearch);
    prevPageBtn.addEventListener('click', prevPage);
    nextPageBtn.addEventListener('click', nextPage);
    formCancelEditBtn.addEventListener('click', resetForm);
</script>
</body>
</html>

